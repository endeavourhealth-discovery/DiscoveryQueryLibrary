use data_extracts;

drop procedure if exists buildCohortForEye;

DELIMITER //
CREATE PROCEDURE buildCohortForEye ()
BEGIN

drop table if exists cohort;
drop table if exists cohort_tmp;

call addCodesToCodeset (212, 'C100.,C1000,C1001,C100z,C101.,C101y,C101z,C102.,C1020,C1021,C102z,C103.,C103y,C103z,C104.,C1040,C1041,C104y,C104z,C105.,C1050,C1051,C105y,C105z,C106.,C1060,C1061,66AJ1,C106y,C106z,C107.,C1070,C1071,C1072,C1073,C1074,C107y,C107z,C108.,C1084,C108A,C108B,C108C,C108D,C108E,C108F,C108G,C108H,C108J,C108y,C108z,C109.,C1099,C109A,C109B,C109C,C109D,C109E,C109F,C109G,C109H,C10A.,C10A0,C10A1,C10A2,C10A3,C10A4,C10A5,C10A6,C10A7,C10AW,C10AX,C10B.,C10B0,C10J.,C10J0,C10P.,C10P0,C10P1,C10y.,C10y0,C10y1,C10yy,C10yz,C10z.,C10z0,C10z1,C10zy,C10zz,C11y0,Cyu2.,Cyu20,Cyu21,Cyu22,Cyu23,L1805,L1806,L1807,L180X,Lyu29,PKyP.,X008t,X40J7,X40J8,X40J9,X40Ja,X40Jb,X40JK,X40JN,X40JR,X40JV,X40JW,X40JX,Xa3ee,Xaagd,Xaage,Xaagf,XaCJ2,XaJlN,XaJUH,XE10E,XE10F,XE10G,XE10H,XE10I,XE128,XE12A,XE12C,XE12G,XE12K,XE12M,XM1Qx,C10..,C1010,C1011,C1030,C1031,C1080,C1081,C1082,C1083,C1085,C1086,C1087,C1088,C1089,C1090,C1091,C1092,C1093,C1094,C1095,C1096,C1097,C109J,C109K,C10C.,C10D.,C10E.,C10E0,C10E1,C10E2,C10E3,C10E4,C10E5,C10E6,C10E7,C10E8,C10E9,C10EA,C10EB,C10EC,C10ED,C10EE,C10EF,C10EG,C10EH,C10EJ,C10EK,C10EL,C10EM,C10EN,C10EP,C10EQ,C10ER,C10F.,C10F0,C10F1,C10F2,C10F3,C10F4,C10F5,C10F6,C10F7,C10F9,C10FA,C10FB,C10FC,C10FD,C10FE,C10FF,C10FG,C10FH,C10FJ,C10FK,C10FL,C10FM,C10FN,C10FP,C10FQ,C10FR,C10FS,C10G.,C10G0,C10H.,C10H0,C10M.,C10M0,C10N.,C10N0,C10N1,X40J4,X40J5,X40J6,X40JA,X40JB,X40JC,X40JG,X40JI,X40JJ,X40JO,X40JS,X40JY,X40JZ,Xa4g7,XaELP,XaELQ,XaEnn,XaEno,XaEnp,XaEnq,XaF04,XaF05,XaFm8,XaFmA,XaFmK,XaFmL,XaFmM,XaFn7,XaFn8,XaFn9,XaFWG,XaFWI,XaIrf,XaIzM,XaIzN,XaIzQ,XaIzR,XaJlL,XaJlM,XaJlQ,XaJlR,XaJQp,XaJSr,XaJUI,XaKyW,XaKyX,XaMzI,XaOPt,XaOPu,XM1Xk,XSETe,XSETH,XSETK,XSETp,', null);

create table cohort_tmp as
	SELECT distinct o.patient_id from enterprise_pi.observation o
	join enterprise_pi.organization org on org.id = o.organization_id
	join data_extracts.code_set_codes r on r.read2_concept_id = o.original_code
	where r.code_set_id = 212
 and org.ods_code in ('F82001','F82002','F82003','F82005','F82006','F82007','F82008','F82009','F82011','F82012','F82014','F82016','F82018','F82019','F82021','F82023','F82025','F82028','F82030','F82034','F82039','F82040','F82042','F82045','F82051','F82053','F82055','F82604','F82607','F82609','F82610','F82612','F82619','F82624','F82625','F82627','F82630','F82634','F82638','F82639','F82642','F82647','F82648','F82649','F82650','F82660','F82661','F82670','F82674','F82675','F82676','F82677','F82679','F82686','F86008','F86009','F86010','F86020','F86022','F86023','F86028','F86032','F86034','F86040','F86042','F86060','F86064','F86066','F86081','F86083','F86085','F86087','F86612','F86624','F86637','F86641','F86642','F86652','F86691','F86692','F86698','F86702','F86703','F86731','Y00090','Y00312','Y00918','Y01719','Y01795','Y02575','Y02973','Y02987','F82010','F82015','F82017','F82027','F82031','F82033','F82038','F82663','F82678','F86007','Y01280');
-- and (org.parent_organization_id in (4978692,2,9792782) or org.ods_code in ('F82003','F82010','F82015','F82017','F82027','F82031','F82033','F82038','F82663','F82678','F86007','Y01280') );

create table cohort as
	SELECT p.id as 'patient_id', p.nhs_number as 'group_by' from data_extracts.cohort_tmp c
    join enterprise_pi.episode_of_care e on e.patient_id = c.patient_id
    join enterprise_pi.patient p on p.id = c.patient_id
	where
  p.date_of_death IS NULL
	and e.registration_type_id = 2
	and e.date_registered <= now()
	and (e.date_registered_end > now() or e.date_registered_end IS NULL)
	and DATEDIFF(NOW(), p.date_of_birth) / 365.25 >= 12;

drop table cohort_tmp;

alter table cohort add index groupByIdx (group_by);

	END//
	DELIMITER ;
