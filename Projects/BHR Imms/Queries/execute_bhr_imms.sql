use data_extracts;

drop procedure if exists createBHRChildImmsReport;

DELIMITER //
CREATE PROCEDURE createBHRChildImmsReport()
BEGIN

DROP TABLE IF EXISTS data_extracts.tmp_imms_cohort;
DROP TABLE IF EXISTS data_extracts.tmp_imms_codes;

-- health imms report cohort
CREATE TABLE data_extracts.tmp_imms_cohort AS
select distinct(p.id) from enterprise_pi.observation o
join enterprise_pi.patient p on p.id = o.patient_id
join enterprise_pi.episode_of_care e on e.patient_id = p.id
join rf2.code_set_codes c on c.ctv3_concept_id = o.original_code
join enterprise_pi.organization org on org.id = o.organization_id
where org.ods_code in
('F82001',
'F82002',
'F82003',
'F82005',
'F82006',
'F82007',
'F82008',
'F82009',
'F82011',
'F82012',
'F82014',
'F82016',
'F82018',
'F82019',
'F82021',
'F82023',
'F82025',
'F82028',
'F82030',
'F82034',
'F82039',
'F82040',
'F82042',
'F82045',
'F82051',
'F82053',
'F82055',
'F82604',
'F82607',
'F82609',
'F82610',
'F82612',
'F82619',
'F82624',
'F82625',
'F82627',
'F82630',
'F82634',
'F82638',
'F82639',
'F82642',
'F82647',
'F82648',
'F82649',
'F82650',
'F82660',
'F82661',
'F82670',
'F82674',
'F82675',
'F82676',
'F82677',
'F82679',
'F82686',
'F86008',
'F86009',
'F86010',
'F86020',
'F86022',
'F86023',
'F86028',
'F86032',
'F86034',
'F86040',
'F86042',
'F86060',
'F86064',
'F86066',
'F86081',
'F86083',
'F86085',
'F86087',
'F86612',
'F86624',
'F86637',
'F86641',
'F86642',
'F86652',
'F86691',
'F86692',
'F86698',
'F86702',
'F86703',
'F86731',
'Y00090',
'Y00312',
'Y00918',
'Y01719',
'Y01795',
'Y02575',
'Y02973',
'Y02987',
'F82010',
'F82015',
'F82017',
'F82027',
'F82031',
'F82033',
'F82038',
'F82663',
'F82678',
'F86007',
'Y01280',
'Y00155', 'F86082', 'F86025', 'F86658', 'F86013', 'F86657', 'F82680')
and c.code_set_id in (200) -- NHS imms codes
and DATEDIFF(NOW(), p.date_of_birth) / 365.25 < 20
and p.date_of_death IS NULL
and e.registration_type_id = 2
and e.date_registered <= NOW()
and (e.date_registered_end > NOW() or e.date_registered_end IS NULL);

INSERT INTO data_extracts.tmp_imms_cohort
select distinct(p.id) from enterprise_pi.observation o
join enterprise_pi.patient p on p.id = o.patient_id
join enterprise_pi.episode_of_care e on e.patient_id = p.id
join rf2.code_set_codes c on c.read2_concept_id = o.original_code
join enterprise_pi.organization org on org.id = o.organization_id
where org.ods_code in
('F82001',
'F82002',
'F82003',
'F82005',
'F82006',
'F82007',
'F82008',
'F82009',
'F82011',
'F82012',
'F82014',
'F82016',
'F82018',
'F82019',
'F82021',
'F82023',
'F82025',
'F82028',
'F82030',
'F82034',
'F82039',
'F82040',
'F82042',
'F82045',
'F82051',
'F82053',
'F82055',
'F82604',
'F82607',
'F82609',
'F82610',
'F82612',
'F82619',
'F82624',
'F82625',
'F82627',
'F82630',
'F82634',
'F82638',
'F82639',
'F82642',
'F82647',
'F82648',
'F82649',
'F82650',
'F82660',
'F82661',
'F82670',
'F82674',
'F82675',
'F82676',
'F82677',
'F82679',
'F82686',
'F86008',
'F86009',
'F86010',
'F86020',
'F86022',
'F86023',
'F86028',
'F86032',
'F86034',
'F86040',
'F86042',
'F86060',
'F86064',
'F86066',
'F86081',
'F86083',
'F86085',
'F86087',
'F86612',
'F86624',
'F86637',
'F86641',
'F86642',
'F86652',
'F86691',
'F86692',
'F86698',
'F86702',
'F86703',
'F86731',
'Y00090',
'Y00312',
'Y00918',
'Y01719',
'Y01795',
'Y02575',
'Y02973',
'Y02987',
'F82010',
'F82015',
'F82017',
'F82027',
'F82031',
'F82033',
'F82038',
'F82663',
'F82678',
'F86007',
'Y01280',
'Y00155', 'F86082', 'F86025', 'F86658', 'F86013', 'F86657', 'F82680')
and c.code_set_id in (200) -- NHS imms codes
and DATEDIFF(NOW(), p.date_of_birth) / 365.25 < 20
and p.date_of_death IS NULL
and e.registration_type_id = 2
and e.date_registered <= NOW()
and (e.date_registered_end > NOW() or e.date_registered_end IS NULL);

-- create report
CREATE TABLE data_extracts.tmp_imms_codes AS
select distinct o.id,o.patient_id,pt.nhs_number,pt.patient_gender_id,dem.forenames,dem.surname,dem.address_line_1,dem.address_line_2,dem.address_line_3,dem.city,pt.postcode,pt.ethnic_code,pt.date_of_birth,clinical_effective_date,org.ods_code,org.name,o.original_code,o.original_term
from enterprise_pi.observation o
join enterprise_pi.organization org on org.id = o.organization_id
join data_extracts.tmp_imms_cohort p on p.id = o.patient_id
join enterprise_pi.patient pt on pt.id = p.id
left join health_checks_bhr.patient_search dem on dem.nhs_number = pt.nhs_number
join rf2.code_set_codes c on c.ctv3_concept_id = o.original_code
where org.ods_code in
('F82001',
'F82002',
'F82003',
'F82005',
'F82006',
'F82007',
'F82008',
'F82009',
'F82011',
'F82012',
'F82014',
'F82016',
'F82018',
'F82019',
'F82021',
'F82023',
'F82025',
'F82028',
'F82030',
'F82034',
'F82039',
'F82040',
'F82042',
'F82045',
'F82051',
'F82053',
'F82055',
'F82604',
'F82607',
'F82609',
'F82610',
'F82612',
'F82619',
'F82624',
'F82625',
'F82627',
'F82630',
'F82634',
'F82638',
'F82639',
'F82642',
'F82647',
'F82648',
'F82649',
'F82650',
'F82660',
'F82661',
'F82670',
'F82674',
'F82675',
'F82676',
'F82677',
'F82679',
'F82686',
'F86008',
'F86009',
'F86010',
'F86020',
'F86022',
'F86023',
'F86028',
'F86032',
'F86034',
'F86040',
'F86042',
'F86060',
'F86064',
'F86066',
'F86081',
'F86083',
'F86085',
'F86087',
'F86612',
'F86624',
'F86637',
'F86641',
'F86642',
'F86652',
'F86691',
'F86692',
'F86698',
'F86702',
'F86703',
'F86731',
'Y00090',
'Y00312',
'Y00918',
'Y01719',
'Y01795',
'Y02575',
'Y02973',
'Y02987',
'F82010',
'F82015',
'F82017',
'F82027',
'F82031',
'F82033',
'F82038',
'F82663',
'F82678',
'F86007',
'Y01280',
'Y00155', 'F86082', 'F86025', 'F86658', 'F86013', 'F86657', 'F82680')
and c.code_set_id in (200);

INSERT INTO data_extracts.tmp_imms_codes
select distinct o.id, o.patient_id,pt.nhs_number,pt.patient_gender_id,dem.forenames,dem.surname,dem.address_line_1,dem.address_line_2,dem.address_line_3,dem.city,pt.postcode,pt.ethnic_code,pt.date_of_birth,clinical_effective_date,org.ods_code,org.name,o.original_code,o.original_term
from enterprise_pi.observation o
join enterprise_pi.organization org on org.id = o.organization_id
join data_extracts.tmp_imms_cohort p on p.id = o.patient_id
join enterprise_pi.patient pt on pt.id = p.id
left join health_checks_bhr.patient_search dem on dem.nhs_number = pt.nhs_number
join rf2.code_set_codes c on c.read2_concept_id = o.original_code
where org.ods_code in
('F82001',
'F82002',
'F82003',
'F82005',
'F82006',
'F82007',
'F82008',
'F82009',
'F82011',
'F82012',
'F82014',
'F82016',
'F82018',
'F82019',
'F82021',
'F82023',
'F82025',
'F82028',
'F82030',
'F82034',
'F82039',
'F82040',
'F82042',
'F82045',
'F82051',
'F82053',
'F82055',
'F82604',
'F82607',
'F82609',
'F82610',
'F82612',
'F82619',
'F82624',
'F82625',
'F82627',
'F82630',
'F82634',
'F82638',
'F82639',
'F82642',
'F82647',
'F82648',
'F82649',
'F82650',
'F82660',
'F82661',
'F82670',
'F82674',
'F82675',
'F82676',
'F82677',
'F82679',
'F82686',
'F86008',
'F86009',
'F86010',
'F86020',
'F86022',
'F86023',
'F86028',
'F86032',
'F86034',
'F86040',
'F86042',
'F86060',
'F86064',
'F86066',
'F86081',
'F86083',
'F86085',
'F86087',
'F86612',
'F86624',
'F86637',
'F86641',
'F86642',
'F86652',
'F86691',
'F86692',
'F86698',
'F86702',
'F86703',
'F86731',
'Y00090',
'Y00312',
'Y00918',
'Y01719',
'Y01795',
'Y02575',
'Y02973',
'Y02987',
'F82010',
'F82015',
'F82017',
'F82027',
'F82031',
'F82033',
'F82038',
'F82663',
'F82678',
'F86007',
'Y01280',
'Y00155', 'F86082', 'F86025', 'F86658', 'F86013', 'F86657', 'F82680')
and c.code_set_id in (200);

drop table if exists data_extracts.bhr_codes;
drop table if exists data_extracts.bhr_demographics;

create table data_extracts.bhr_codes as
  select distinct id,patient_id,nhs_number,clinical_effective_date,ods_code,name as practice_name,original_code,original_term
  from data_extracts.tmp_imms_codes
  where nhs_number is not null
  order by ods_code,nhs_number, original_code desc,clinical_effective_date;

create table data_extracts.bhr_demographics as
    select distinct patient_id,nhs_number,patient_gender_id,forenames,surname,address_line_1,address_line_2,address_line_3,city,postcode,ethnic_code,date_of_birth
    from data_extracts.tmp_imms_codes
    where nhs_number is not null
    order by ods_code,nhs_number, original_code desc,clinical_effective_date;

--    select * from  data_extracts.tmp_imms_codes join (select nhs_number, max(last_updated) from group by nhs_number)

alter table data_extracts.bhr_codes add index idIdx (id);
alter table data_extracts.bhr_demographics add index patientIdIdx (patient_id);

END//
DELIMITER ;
